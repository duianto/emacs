#+TITLE: Emacs の設定
#+DATE: 2019-01-11 15:07:34
#+COLUMNS: %25ITEM %TAGS %PRIORITY %TODO
* ヘッダ
  #+BEGIN_SRC emacs-lisp
;; -*- lexical-binding: t -*-
;; Configurations for Emacs
;; Youhei SASAKI <uwabami@gfd-dennou.org>
;; see also https://uwabami.github.io/cc-env/Emacs.html
  #+END_SRC
* ディレクトリ構成
  分割した設定ファイル群やパッケージで install したパッケージ
  の置き場所は =user-emacs-directory= 以下にまとめています．

  試行錯誤の結果，ディレクトリ構成は以下のようにしました:
  #+BEGIN_EXAMPLE
    ~/.emacs.d/
     |-- Makefile    ←  byte-compile 用の rule
     |-- README.org  ←  本ファイル．`org-babel-tangle' で init.el を生成
     |-- modules/    ←  git submodules. 今の所 leaf.el のみ
     |-- pkg/
         |-- elpa/   ←  package.el で導入したパッケージが置かれる場所
         `-- quelpa/ ←  quelpa で導入したパッケージが置かれる場所
     |-- share/      ←  (基本的に)参照するだけの資源置き場所
     `-- tmp/        ←  一次ファイルの置き場所
  #+END_EXAMPLE
  上記ディレクトリ構成を設定ファイルで使用するためにディレクトリ配置を宣言しておきます．
  #+BEGIN_SRC emacs-lisp
(when load-file-name
  (setq user-emacs-directory (file-name-directory load-file-name)))
(defconst my:d:share
  (expand-file-name "share/" user-emacs-directory))
(defconst my:d:tmp
  (expand-file-name "tmp/" user-emacs-directory))
  #+END_SRC
  ついでに，
  =custom-set-variables= は別ファイルに出力，終了時に削除するようにしています．
  #+BEGIN_SRC emacs-lisp
(setq custom-file (concat my:d:tmp "custom.el"))
(add-hook 'kill-emacs-hook
          (lambda ()
            (if (file-exists-p custom-file)
                (delete-file custom-file))))
  #+END_SRC
  +init.elが汚れる気がしてあまり好きではないのですが...皆さん気にしてないんですかね+
* Package の初期化
  ほとんど leaf で設定するので不要?
  #+BEGIN_SRC emacs-lisp
(add-to-list 'load-path (locate-user-emacs-file "modules/leaf.el/"))
(require 'leaf nil 'noerror)
(leaf package
  :init
  (setq package-enable-at-startup t
        package-user-dir (locate-user-emacs-file "pkg/elpa")
        package-gnupghome-dir (expand-file-name ".gnupg" (getenv "HOME")))
  (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
  (eval-when-compile
    (unless (file-exists-p (locate-user-emacs-file "tmp/bootstrap-stamp"))
      (package-refresh-contents)))
  :config
  (package-initialize)
  (setq leaf-backend/:ensure 'package)
  )
   #+END_SRC
  bind-key
  #+BEGIN_SRC emacs-lisp
(leaf bind-key
  :ensure t
  :config
  (setq leaf-backend/:bind  'bind-key
        leaf-backend/:bind* 'bind-key))
  #+END_SRC
  quelpa
  #+BEGIN_SRC emacs-lisp
(leaf quelpa
  :ensure t
  :init
  (setq quelpa-dir (locate-user-emacs-file "pkg/quelpa")
        quelpa-upgrade-p nil
        quelpa-checkout-melpa-p nil
        quelpa-update-melpa-p nil
        quelpa-melpa-recipe-stores nil)
  )
  #+END_SRC
  その他, 便利なアレコレ
  #+BEGIN_SRC emacs-lisp
(leaf cl-lib)
(leaf el-x     :ensure t :require t)
(leaf diminish :ensure t)
(leaf s        :ensure t)
  #+END_SRC
* 独自関数
  細かい独自関数，など．
** カーソルのある位置の face を調べる関数
   わりと良く使う. 地味に便利
   #+BEGIN_SRC emacs-lisp
(defun my:describe-face-at-point ()
  (interactive)
  (message "%s" (get-char-property (point) 'face)))
   #+END_SRC
** 機能を無効化するための関数の定義
   =line-number-mode= など「有効無効をtoggleする関数」は
   慣習的に =0= 以下の数字を指定すると明示的に無効化できるので，
   =-1= を設定する関数を定義しておく.
   #+BEGIN_SRC emacs-lisp
(defun my:disable-builtin-mode (mode)
  "与えられた mode が存在するのであれば -1 をセットして無効化"
  (if (fboundp mode) (funcall mode -1)))
   #+END_SRC
** dpkg-status
   もっと良い方法がありそうなモンですが．
   #+BEGIN_SRC emacs-lisp
(defun my:dpkg-status (package)
  "Return the package status from dpkg --get-selections."
  (string-match "^ii" (shell-command-to-string (format "dpkg -l %s" package))))
   #+END_SRC
** 行末の無駄な空白/改行を削除する
   @see [[http://d.hatena.ne.jp/tototoshi/20101202/1291289625][無駄な行末の空白を削除する(Emacs Advent Calendar jp:2010)]]

   ただし, RD や Markdown だと空白行に意味があったりするので，
   必要に応じて拡張子で判断して外している．
   #+BEGIN_SRC emacs-lisp
(defvar my:delete-trailing-whitespace-exclude-suffix
  (list "\\.rd$" "\\.md$" "\\.rbt$" "\\.rab$"))
(defun my:delete-trailing-whitespace ()
  (interactive)
  (cond
   ((equal nil
           (cl-loop for pattern in my:delete-trailing-whitespace-exclude-suffix
                    thereis (string-match pattern buffer-file-name)))
    (delete-trailing-whitespace))))
(add-hook 'before-save-hook 'my:delete-trailing-whitespace)
   #+END_SRC
** 空になったファイルを尋ねずに自動削除
   ゴミが残らないし，地味に便利．
   #+BEGIN_SRC emacs-lisp
(defun my:delete-file-if-no-contents ()
  (when (and (buffer-file-name (current-buffer))
             (= (point-min) (point-max)))
    (delete-file
     (buffer-file-name (current-buffer)))))
(if (not (memq 'my:delete-file-if-no-contents after-save-hook))
    (setq after-save-hook
          (cons 'my:delete-file-if-no-contents after-save-hook)))
   #+END_SRC
** scratch を殺さない. 消したら再生成
   ...元ネタがどこだったのか忘れてしまった...
   #+BEGIN_SRC emacs-lisp
(defun my:make-scratch (&optional arg)
  (interactive)
  (progn
    ;; "*scratch*" を作成して buffer-list に放り込む
    (set-buffer (get-buffer-create "*scratch*"))
    (funcall initial-major-mode)
    (erase-buffer)
    (when (and initial-scratch-message (not inhibit-startup-message))
      (insert initial-scratch-message))
    (or arg
        (progn
          (setq arg 0)
          (switch-to-buffer "*scratch*")))
    (cond ((= arg 0) (message "*scratch* is cleared up."))
          ((= arg 1) (message "another *scratch* is created")))))

(defun my:buffer-name-list ()
  (mapcar (function buffer-name) (buffer-list)))
(add-hook 'kill-buffer-query-functions
          ;; *scratch* バッファで kill-buffer したら内容を消去するだけにする
          (function (lambda ()
                      (if (string= "*scratch*" (buffer-name))
                          (progn (my:make-scratch 0) nil)
                        t))))
(add-hook 'after-save-hook
          ;; *scratch* バッファの内容を保存したら
          ;; *scratch* バッファを新しく作る.
          (function
           (lambda ()
             (unless (member "*scratch*" (my:buffer-name-list))
               (my:make-scratch 1)))))
   #+END_SRC
** ファイル名を minibuffer におさまる様に整形
   zsh 風味
   #+BEGIN_SRC emacs-lisp
(defun my:shorten-file-path (fpath max-length)
  "Show up to `max-length' characters of a directory name `fpath' like zsh"
  (let* ((path (reverse (split-string (abbreviate-file-name fpath) "/")))
         (output "")
         (top (string-join (reverse (last path 3)) "/"))
         (vmax (- max-length 4 (length top)))
         (path (butlast path 3))
         )
    (while (and path
                (and (< (length output) vmax)
                     (< (length (concat "/" (car path) output)) vmax)))
      (setq output (concat "/" (car path) output))
      (setq path (cdr path)))
    ;; 省略
    (when path
      (setq output (concat "/..." output)))
    (format "%s%s" top output)
    ))
   #+END_SRC
* 環境変数の読み込み: =exec-path-from-shell=
  zsh で設定した =PATH= などの環境変数を Emacs に引き継ぐために
  [[https://github.com/purcell/exec-path-from-shell][purcell/exec-path-from-shell]] を使います．
  今の所
  - =SHELL=
  - =DEBFULLNAME=
  - =DEBEMAIL=
  - =TEXMFHOME=
  - =SKKSERVER=
  - =http_proxy=
  - =GPG_KEY_ID=
  - =GPG_AGENT_INFO=
  - =PASSWORD_STORE_DIR=
  - =PATH=
  を読み込んでいます．
  #+BEGIN_SRC emacs-lisp
(defvar my:d:password-store nil)
(leaf exec-path-from-shell
  :ensure t
  :config
  (when (memq window-system '(mac ns)) (exec-path-from-shell-initialize))
  (exec-path-from-shell-copy-envs
   '("SHELL"
     "DEBFULLNAME"
     "DEBEMAIL"
     "SKKSERVER"
     "TEXMFHOME"
     "http_proxy"
     "GPG_KEY_ID"
     "GPG_AGENT_INFO"
     "PASSWORD_STORE_DIR"
     "PATH"
     ))
  (setq user-full-name (concat (getenv "DEBFULLNAME"))
        user-mail-address (concat (getenv "DEBEMAIL"))
        my:d:password-store (concat (getenv "PASSWORD_STORE_DIR") "/Emacs/" (system-name)))
  )
  #+END_SRC
* 言語の設定
  日本語, UTF-8 にしています.
  #+BEGIN_SRC emacs-lisp
(set-language-environment "Japanese")
(prefer-coding-system 'utf-8)
(set-file-name-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-default 'buffer-file-coding-system 'utf-8)
  #+END_SRC
  その他, 機種依存文字等についての設定をアレコレ.
** cp5022x.el
   Emacs23 から内部が Unicode ベースになっています．

   しかし文字コードの変換は GNU libc の iconv をベースにしているため，
   環境によっては文字の変換がうまく行なえません．
   そこで言語設定前に =cp5022x.el= をインストールすることにしています．
   #+BEGIN_SRC emacs-lisp
(leaf cp5022x
  :ensure t
  :config
  (set-charset-priority 'ascii 'japanese-jisx0208 'latin-jisx0201
                        'katakana-jisx0201 'iso-8859-1 'unicode)
  (set-coding-system-priority 'utf-8 'euc-jp 'iso-2022-jp 'cp932)
  )
   #+END_SRC
** East Asian Ambiguos 対応
   CJK 以外の East Asian Ambiguos，絵文字も2文字幅にするようにしています．
   拙作の修正ロケールはこちら: [[https://github.com/uwabami/locale-eaw-emoji]]
   #+BEGIN_SRC emacs-lisp
(unless (package-installed-p 'locale-eaw-emoji)
  (quelpa '(locale-eaw-emoji
            :fetcher github
            :repo "uwabami/locale-eaw-emoji")))
(leaf locale-eaw-emoji
  :config
  (eaw-and-emoji-fullwidth))
   #+END_SRC
** OSの違いに起因する条件分岐
   Mac と Linux では同じ Unicode でも正規化が異なります
   (具体的には Mac のファイルシステムである HFS+ では Unicode の正規化が異なります).
   Unicode の正規化と Mac OS X 特有の事情については
   - [[http://homepage1.nifty.com/nomenclator/unicode/normalization.htm][Unicode正規化とは]]
   - [[http://www.sakito.com/2010/05/mac-os-x-normalization.html][Mac OS X におけるファイル名に関するメモ(NFC, NFD等)]]
   等が参考になるでしょう.

   日本語のファイル名を扱うことは滅多にないものの,
   たまに祟りがあるのでそれを回避するための設定をしています.

   Windows の場合はファイル名などは cp932 にしているものの,
   最近 Windows 使っていないので良く知りません(というわけで，設定を捨てました).
   +さらに，最近は Mac OS でも Emacs 使ってないから，これが正しのか良くわからない...+
   #+BEGIN_SRC emacs-lisp
(leaf ucs-normalize
  :if (eq system-type 'darwin)
  :byte-compile-vars mac-pass-control-to-system ns-command-modifier ns-alternate-modifier
  :config
  (set-file-name-coding-system 'utf-8-hfs)
  (setq locale-coding-system 'utf-8-hfs)
  ;; ついでにキーバインド: Ctrl を Mac から奪い取る
  (setq mac-pass-control-to-system t)
  ;; Cmd と Option を逆にする
  (setq ns-command-modifier 'meta)
  (setq ns-alternate-modifier 'super)
  (global-set-key [ns-drag-file] 'ns-find-file)
  )
   #+END_SRC
* Elscreen
** 導入 [0/1]
   modeline の表示そのものは無効化しておく．
   - [ ] Debian パッケージ版は古い．更新すべき
   #+BEGIN_SRC emacs-lisp
(quelpa '(elscreen
          :fetcher github
          :repo "emacs-jp/elscreen"))
(leaf elscreen
  :init
  (setq elscreen-tab-display-control nil
        elscreen-prefix-key (kbd "C-o")
        elscreen-display-tab 8
        elscreen-display-screen-number nil)
  :config
  (elscreen-start))
   #+END_SRC
** elscreen + zsh での連携
  詳細は
  - [[https://masutaka.net/chalow/2011-09-28-1.html][ターミナルの zsh と Emacs を風のように駆け抜ける！]]
  - [[http://syohex.hatenablog.com/entry/20111026/1319606395][cdeを改良]]
  - [[https://qiita.com/__hage/items/2dd732b4dd68e124e8bd][cdeとelscreen-separate-buffer-listの相性が悪い]]
  などを参考に.
  #+BEGIN_SRC emacs-lisp
(defun return-current-working-directory-to-shell ()
  (expand-file-name
   (with-current-buffer
       (if (featurep 'elscreen)
           (let* ((frame-confs (elscreen-get-frame-confs (selected-frame)))
                  (num (nth 1 (assoc 'screen-history frame-confs)))
                  (cur-window-conf
                   (assoc 'window-configuration
                          (assoc num (assoc 'screen-property frame-confs))))
                  (marker (nth 2 cur-window-conf)))
             (marker-buffer marker))
         (nth 1
              (assoc 'buffer-list
                     (nth 1 (nth 1 (current-frame-configuration))))))
     default-directory)))
  #+END_SRC
* 日本語入力: =ddskk=
  [[http://openlab.ring.gr.jp/skk/ddskk-ja.html][Daredevil SKK (DDSKK)]] をメインで使用中．無いと途方に暮れる．
  ちなみにGTKが有効になっていると =gtk-immodule= なんかと衝突するので
  =~/.Xresources= で xim を無効にしておくと良い．
  例えば以下の様に:
  #+BEGIN_SRC conf :tangle no
! disable XIM
Emacs*useXIM: false
  #+END_SRC
** Emacs 本体側の設定
   実際の設定は別ファイルで行なわれるため
   ここでは設定ファイルの位置変更を変更している．
   #+BEGIN_SRC emacs-lisp
(unless (require 'skk nil 'noerror)
  (package-install 'ddskk))
(leaf skk
  :bind (("C-x j"   . skk-mode)
         ("C-x C-j" . skk-mode)
         ("C-\\"    . skk-mode))
  :init
  (setq skk-user-directory (concat my:d:tmp "skk")
        skk-init-file (concat user-emacs-directory "init-ddskk")
        default-input-method "japanese-skk" )
  )
   #+END_SRC
** DDSKK 本体の設定
   sticky shift: [[http://homepage1.nifty.com/blankspace/emacs/sticky.html][sticky shift]] を参照のこと.
   ddskk の 14.2 以降から同梱されるようになった(ありがたい)
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-sticky-key ";")
   #+END_SRC
   変換候補の表示位置
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-show-candidates-always-pop-to-buffer t)
   #+END_SRC
   候補表示件数を2列に
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-henkan-show-candidates-rows 2)
   #+END_SRC
   日本語表示しない
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-japanese-message-and-error nil)
   #+END_SRC
   メニューを日本語にしない -> toolbar 非表示だし.
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-show-japanese-menu nil)
   #+END_SRC
   注釈の表示
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-show-annotation nil)
   #+END_SRC
   インジケータの表示のカスタマイズ
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-latin-mode-string "[_A]")
(setq skk-hiragana-mode-string "[あ]")
(setq skk-katakana-mode-string "[ア]")
(setq skk-jisx0208-latin-mode-string "[Ａ]")
(setq skk-jisx0201-mode-string "[_ｱ]")
(setq skk-abbrev-mode-string "[aA]")
(setq skk-indicator-use-cursor-color nil)
   #+END_SRC
   インジケータを左端に表示
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-status-indicator 'left)
   #+END_SRC
   mode-line が動くのが許せないので，ちょっと修正
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(defadvice skk-make-indicator-alist
    (after my:set-skk-default-indicator activate)
  (dolist (elem
           '((abbrev " [aA]" . "--[aA]:")
             (latin " [_A]" . "--[_A]:")
             (default " [--]" . "--[--]:")))
    (setq ad-return-value
          (append (cons elem nil)
                  (delq (assoc (car elem) ad-return-value) ad-return-value)))))
(setq skk-show-inline t)
   #+END_SRC
   カーソルには色をつけない
   #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-use-color-cursor nil)
   #+END_SRC
*** 編集関連
    キーバインド
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(global-set-key "\C-x\C-j" 'skk-mode)
(global-set-key "\C-xj" 'skk-mode)
(global-set-key "\C-j" 'skk-mode)
(global-set-key "\C-\\" 'skk-mode)
    #+END_SRC
    半角カナを入力
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-use-jisx0201-input-method t)
    #+END_SRC
    Enter で改行しない
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-egg-like-newline t)
    #+END_SRC
    "「"を入力したら"」"も自動で挿入
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-auto-insert-paren t)
    #+END_SRC
    句読点変換ルール
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-kuten-touten-alist
      '(
        (jp    . ("。" . "、"))
        (en-jp . ("．" . "，"))
        (en    . (". " . ", "))
        ))
(setq-default skk-kutouten-type 'en)
    #+END_SRC
    全角記号の変換: @ での日付入力は使わない
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-rom-kana-rule-list
      (append skk-rom-kana-rule-list
              '(("!" nil "!")
                (":" nil ":")
                (";" nil ";")
                ("?" nil "?")
                ("z " nil "　")
                ("\\" nil "\\")
                ("@" nil "@")
                )))
    #+END_SRC
    送り仮名が厳密に正しい候補を優先
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-henkan-strict-okuri-precedence t)
    #+END_SRC
    辞書の共有
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-share-private-jisyo t)
    #+END_SRC
    変換候補を縦に表示
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-show-inline 'vertical)
    #+END_SRC
*** インクリメンタルサーチ
    minibuffer 内では強制的に skk off.
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(add-hook 'skk-mode-hook
          (lambda ()
            (and (skk-in-minibuffer-p)
                 (skk-mode-exit))))
(setq skk-isearch-start-mode 'latin)
    #+END_SRC
    インクリメンタルサーチは migemo に任せることに．
*** 辞書の設定
    追加している辞書の一覧は
    - [[http://www.chibutsu.org/jisho/][地球物理辞書]]
    - [[http://www.geocities.jp/living_with_plasma/tanudic.html][天文・天体物理用語の漢字変換用辞書]]
    - はてなキーワード
    - [[http://matsucon.net/material/dic/][2ちゃんねる顔文字辞書 MatsuCon]]
    - [[http://matsucon.net/][MatsuCon]]
    といった所.
    はてなキーワードからの辞書の抽出は [[http://d.hatena.ne.jp/znz][znz]] さんの
     - [[http://rubyist.g.hatena.ne.jp/znz/20060924/p1][「はてなダイアリーキーワードふりがなリスト」を SKK の辞書に変換]]
    を参考に.
    [[http://matsucon.net/][MatsuCon]] で公開されている顔文字に関しては
    顔文字に ; や が含まれている場合に, 適宜quoteする必要があるので
    以下のスクリプトで適当に変換.
    #+BEGIN_SRC ruby :tangle no
#!/usr/bin/env ruby
require 'nkf'
src = ARGV[0]
if ARGV.size < 1
  puts "usage: ime2skk.rb ime_dictionary"
  exit 0
end
File.open(src, "r") {|f|
  f.each do |line|
    line_euc = NKF.nkf("-S -e",line)
    if line_euc =~ /^([^!]+?)\t(.+?)\t.+$/
      entry = $1
      content = $2
      if content =~/;/
        puts entry + " /(concat \"" + content.gsub(';','\\\\073') + "\")/"
      elsif content =~/\//
        puts entry + " /(concat \"" + content.gsub('/','\\\\057') + "\")/"
      else
        puts entry + " /" + content + "/"
      end
    end
  end
}
    #+END_SRC
    他にも quote する必要あるような気もするけれど, それは気がついた時に.

    辞書サーバの指定は以下.
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(cond
 ((getenv "SKKSERVER")
  (setq skk-server-host "127.0.0.1"
        skk-server-portnum "1178"
        skk-large-jisyo  nil)
  (add-to-list 'skk-search-prog-list
               '(skk-server-completion-search) t)
  (add-to-list 'skk-search-prog-list
               '(skk-comp-by-server-completion) t))
 (t
  (setq skk-get-jisyo-directory (concat my:d:tmp "skk-jisyo")
        skk-large-jisyo (concat skk-get-jisyo-directory "/SKK-JISYO.L")))
 )
(when (file-exists-p "/usr/local/share/skkdic/SKK-JISYO.emoji.utf8")
  (setq skk-extra-jisyo-file-list
        (list '("/usr/local/share/skkdic/SKK-JISYO.emoji.utf8" . utf-8))))
    #+END_SRC
    辞書登録の際に送り仮名を削除
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-check-okurigana-on-touroku 'auto)
    #+END_SRC
    漢字登録のミスをチェックする
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(setq skk-check-okurigana-on-touroku t)
    #+END_SRC
*** 動的補完
    まだ設定していない...
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
    ;; ;; 動的補完
    ;; (setq skk-dcomp-activate t)
    ;; (setq skk-dcomp-multiple-activate t)
    ;; (setq skk-dcomp-multiple-rows 5)
    ;; ;; 動的補完の複数表示群のフェイス
    ;; (set-face-foreground 'skk-dcomp-multiple-face "Black")
    ;; (set-face-background 'skk-dcomp-multiple-face "LightGoldenrodYellow")
    ;; (set-face-bold-p 'skk-dcomp-multiple-face nil)
    ;; ;; 動的補完の複数表示郡の補完部分のフェイス
    ;; (set-face-foreground 'skk-dcomp-multiple-trailing-face "dim gray")
    ;; (set-face-bold-p 'skk-dcomp-multiple-trailing-face nil)
    ;; ;; 動的補完の複数表示郡の選択対象のフェイス
    ;; (set-face-foreground 'skk-dcomp-multiple-selected-face "White")
    ;; (set-face-background 'skk-dcomp-multiple-selected-face "LightGoldenrod4")
    ;; (set-face-bold-p 'skk-dcomp-multiple-selected-face nil)
    #+END_SRC
*** 部首変換, 総画数変換
    上手く使いこなせていない
    #+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(add-to-list 'skk-search-prog-list
             '(skk-tankan-search 'skk-search-jisyo-file
                                 skk-large-jisyo 10000))
    #+END_SRC
* Copy & Paste
** Linux: =xclip=
   =xclip= で clipboard とデータをやりとり．
   #+BEGIN_SRC emacs-lisp
(leaf xclip
  :if (executable-find "xclip")
  :ensure t
  :config
  (xclip-mode 1))
   #+END_SRC
   clipboard と PRIMARY の同期には =gpaste= を使っている．
* インクリメンタル検索: =migemo=
  #+BEGIN_SRC emacs-lisp
(quelpa '(migemo
          :fetcher github
          :repo "uwabami/migemo"))
(leaf migemo
  :if (executable-find "cmigemo")
  :byte-compile-funcs ((migemo . migemo-init))
  :config
  (setq migemo-command "cmigemo"
        migemo-options '("-q" "--emacs")
        migemo-dictionary "/usr/share/cmigemo/utf-8/migemo-dict"
        migemo-user-dictionary nil
        migemo-regex-dictionary nil
        migemo-coding-system 'utf-8-unix)
  (with-eval-after-load "migemo"
    (migemo-init))
  )
  #+END_SRC
* 補完: =ido=
  補完は =ido= が軽いし速いので好み.
  見た目がちょっと簡素すぎる気もするので、なんとか弄りたい所ではある。
** =ido= の設定
   #+BEGIN_SRC emacs-lisp
(leaf ido
  :bind (("C-x C-f" . ido-find-file)
         )
  :config
  (ido-mode t)
  ;; (ido-everywhere t)  ; <- Wanderlust みたいに, 過去の選択を覚えている奴と相性悪い.
  (setq ido-enable-prefix nil             ; prefix match 入力を先頭一致可能
        ido-confirm-unique-completion t   ; TAB で名前の一致まで. その後 RET で実行
        ido-enable-flex-matching t        ; flx matching を試す際には prefix を無効化すること
        ido-enable-dot-prefix t           ; . を prefix として扱う
        ido-default-file-method   'selected-window
        ido-default-buffer-method 'selected-window
        ido-max-directory-size 10000
        ido-enable-tramp-completion nil
        ido-use-faces t
        ido-ignore-extensions t
        ido-cannot-complete-command 'ido-next-match
        ido-save-directory-list-file (concat my:d:tmp "ido.last"))
  ;; 補完で無視する拡張子の追加．そのうち増える．
  (cl-loop for ext in
           '(".dvi"
             ".fdb_latexmk"
             ".fls"
             ".ilg"
             ".jqz"
             ".mod"
             ".nav"
             ".out"
             ".snm"
             ".synctex.gz"
             ".vrb"
             )
           do (add-to-list 'completion-ignored-extensions ext))
  (add-hook 'ido-setup-hook
            (lambda ()
              (define-key ido-completion-map (kbd "C-h") 'ido-delete-backward-updir)
              (define-key ido-completion-map (kbd "C-l") 'ido-delete-backward-updir)))
  (defun my:ido-disable-line-trucation ()
    (set (make-local-variable 'truncate-lines) nil))
  (add-hook 'ido-minibuffer-setup-hook 'my:ido-disable-line-trucation)
  )
   #+END_SRC
** =flx-ido=: flex match の強化
   曖昧マッチが非常に直感的になった．地味に便利で手放せない．
   #+BEGIN_SRC emacs-lisp
(leaf flx-ido
  :ensure t
  :config
  (flx-ido-mode 1)
  (setq flx-ido-use-faces nil
        flx-ido-threshold 10000)
  )
   #+END_SRC
** =ido-grid-mode=: 候補を並べて表示
   横に並ぶと正直シンドイので並べてみる。
   #+BEGIN_SRC emacs-lisp
(quelpa '(ido-grid
          :fetcher github
          :repo "larkery/ido-grid.el"))
(leaf ido-grid
  :config
  (setq ido-grid-enabled t
        ido-grid-start-small nil
        ido-grid-rows 0.15
        ido-grid-max-columns nil
        ido-grid-indent 1
        ido-grid-column-padding 3
        ido-grid-bind-keys t
        ido-max-directory-size 100000  ;; avoid [Too Big]
        )
  (ido-grid-enable)
  (defun my:ido-grid-force-one-columns (o &rest args)
    (let ((ido-grid-max-columns 1)   ;; single vertical col
          (ido-grid-start-small nil) ;; popup immediately
          (ido-grid-rows 0.15))      ;; 15% of frame height
      (apply o args)
      ))
  )
   #+END_SRC
** =ido-recentf=: recentf を ido で
   "recentf-list" の結果を整形して, minibuffer に納まる様に縮小したり
   #+BEGIN_SRC emacs-lisp
(defun ido-recentf-open ()
  "Use `ido-completing-read' to \\[find-file] a recent file"
  (interactive)
  (let ((files (mapcar (lambda (f)
                         (cons (my:shorten-file-path f 77) f))
                       recentf-list)))
    (let ((selected (ido-completing-read "Files: " (mapcar #'car files))))
      (find-file (assoc-default selected files)))))
(bind-key "C-x C-r" 'ido-recentf-open)
   #+END_SRC
** =smex=
   M-x を ido で。
   #+BEGIN_SRC emacs-lisp
(leaf smex
  :ensure t
  :bind (("M-x" . smex))
  :config
  (setq smex-auto-update t
        smex-save-file (concat my:d:tmp "smex-items")
        smex-prompt-string "smex: "
        smex-flex-matching nil
        )
  )
   #+END_SRC
* 認証関連: =id-manager=, =plstore=, =oauth2=, =password-store=
** oauth2, plstore
   oauth2 の認証情報は =plstore= で保存される．
   ファイルの置き場所と暗号鍵の設定をしておく.
   #+BEGIN_SRC emacs-lisp
(leaf oauth2
  :ensure t
  :init
  (leaf plstore
    :if (getenv "GPG_KEY_ID")
    :init
    (setq plstore-secret-keys 'silent
          plstore-encrypt-to (getenv "GPG_KEY_ID")))
  (setq oauth2-token-file (concat my:d:tmp "oauth2.plstore")))
   #+END_SRC
** password-store
   #+BEGIN_SRC emacs-lisp
(leaf password-store
  :if (and my:d:password-store
           (executable-find "pass"))
  :ensure t
  )
   #+END_SRC
** auth-password-store
   auth-source として =password-store= を使う拡張
   #+BEGIN_SRC emacs-lisp
(leaf auth-source-pass
  :if (and my:d:password-store
           (executable-find "pass"))
  :ensure t
  )
   #+END_SRC
* MUA の設定: =wanderlust=
  MUA として Wanderlust を使っている
** Emacs 本体側の設定
   Emacs 本体での設定は以下の通り. Wanderlust 自体の設定は別ファイルで行なわれる．
   ここでは =wl-init-file= を指定することで，設定ファイルを明示している．
   #+BEGIN_SRC emacs-lisp
(leaf wl
  :if (and (or (my:dpkg-status "wl")
               (my:dpkg-status "wl-beta"))
           (my:dpkg-status "rail"))
;;  :commands (wl wl-other-frame wl-draft wl-user-agent wl-user-agent-compose wl-draft-send wl-draft-kill)
  :init
  (define-mail-user-agent
    'wl-user-agent
    'wl-user-agent-compose
    'wl-draft-send
    'wl-draft-kill
    'mail-send-hook)
  (setq elmo-msgdb-directory "~/.cache/wanderlust"
        elmo-maildir-folder-path "~/.cache/wanderlust"
        elmo-cache-directory "~/.cache/wanderlust"
        wl-score-files-directory "~/.cache/wanderlust"
        wl-init-file (concat user-emacs-directory "init-wl")
        mail-user-agent 'wl-user-agent
        read-mail-command 'wl)
  (unless (file-directory-p elmo-msgdb-directory)
    (make-directory elmo-msgdb-directory))
  (unless (file-directory-p (concat elmo-msgdb-directory "/local"))
    (make-directory (concat elmo-msgdb-directory "/local")))
  (unless (file-directory-p (concat elmo-msgdb-directory "/local/Trash"))
    (make-directory (concat elmo-msgdb-directory "/local/Trash")))
  )
   #+END_SRC
   割と =/etc/emacs/site-start.d/65wl-beta.el= と重複している気がするが...
** Wanderlust 本体の設定
   実際の設定は以下の通り
*** byte compile 用
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(eval-and-compile
  (progn
    (require 'wl)
    (require 'mime-def)
    (require 'cp5022x)
    (require 'el-x)
    ))
    #+END_SRC
*** 依存/追加ライブラリのインストールと読み込み
**** rail
     SEMI や FLIM などの UA の表示に [[http://uwabami.github.com/rail/][rail]] を使っている.
     ちなみに rail を有効にすると, 以下の様に User-Agent が表示される
     #+HTML: <div class="col-7 px2 mx-auto">
     #+HTML: <amp-img layout="responsive" width=640 height=400 src="https://uwabami.github.io/software/rail/images/wanderlust_with_or_without_rail.png" alt="rail preview"></amp-img>
     #+HTML: </div>

     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(leaf rail
  :config
  (setq rail-emulate-genjis t))
     #+END_SRC
**** cp5022x を使う
     ISO-2022-JP を CP50220 として扱う.
     [[http://d.hatena.ne.jp/kiwanami/20091103/1257243524][Wanderlustと文字コード]] も参照のこと.
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(add-to-list 'mime-charset-coding-system-alist '(iso-2022-jp . cp50220))
(setq wl-mime-charset 'iso-2022-jp)
     #+END_SRC
**** elscreen-wl
     メール作成時に =elscreen= と連携してくれる．便利
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
; (use-package elscreen-wl)
     #+END_SRC
**** SEMI の追加設定
     HTML メールを表示するために eww を使う.
     mime-setup がロードされる前に記述する必要あり.
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
;; (setq mime-view-text/html-previewer 'shr)
;; (setq mime-setup-enable-inline-html 'shr)
;; 幅指定 → 実際の関数は eww の設定を参照
;; (defun my:mime-shr-preview-text/html (&rest args)
;;   (advice-add 'shr-insert-document :around 'my:shr-insert-document)
;;   (unwind-protect
;;       (apply args)
;;     (advice-remove 'shr-insert-document 'my:shr-insert-document)))
;; (advice-add 'mime-shr-preview-text/html :around
;;             'my:mime-shr-preview-text/html)
;;
(leaf mime-setup)
     #+END_SRC
     どのアプリケーションで開くか → =xdg-open= に丸投げ．
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
;; (setq mime-view-mailcap-files '("~/.mailcap"))
     #+END_SRC
     =~/.mailcap= 自体は以下
     #+BEGIN_SRC conf :tangle no
applications/*; xdg-open %s;
image/*; xdg-open %s;
video/*; xdg-open %s;
     #+END_SRC
     MIME の例の保存先の変更
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq mime-situation-examples-file
      (concat my:d:tmp "mime-example"))
     #+END_SRC
     text/plain を html より優先
     #+BEGIN_SRC emacs-lisp :tangle no
(setq mime-view-type-subtype-score-alist
      '(((text . plain) . 0)
        ((text . html)  . 1)
        ))
     #+END_SRC
     音を鳴らすアレやコレの無効化
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq mime-play-find-every-situations nil
      mime-play-delete-file-immediately nil
      process-connection-type nil)
    #+END_SRC
*** 個人情報の設定
    具体的な設定内容は以下のファイルに置いている
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(with-eval-after-load "wl"
  (load (concat my:d:password-store "/wl-info.gpg")))
     #+END_SRC
    設定している内容は以下の通り
**** 自身のメールアドレスと購読メーリングリストの設定
     #+BEGIN_SRC emacs-lisp :tangle no
;; From: の設定
(setq wl-from (concat user-full-name " <" user-mail-address ">"))
;; (system-name) が FQDN を返さない場合、
;; `wl-local-domain' にホスト名を除いたドメイン名を設定
(setq wl-local-domain "example.com")
;; 自分のメールアドレスのリスト
(setq wl-user-mail-address-list
      (list (wl-address-header-extract-address wl-from)
            ;; "e-mail2@example.com"
            ;; "e-mail3@example.net" ...
            ))
;; 自分の参加しているメーリングリストのリスト
(setq wl-subscribed-mailing-list
      '("wl@lists.airs.net"
        "apel-ja@m17n.org"
        "emacs-mime-ja@m17n.org"
        ;; "ml@example.com" ...
        ))
     #+END_SRC
**** 送受信用サーバの設定
     受信(IMAP)
     #+BEGIN_SRC emacs-lisp :tangle no
(setq elmo-imap4-default-server "your imap server")
(setq elmo-imap4-default-port '993)
(setq elmo-imap4-default-stream-type 'ssl)
     #+END_SRC
     送信(SMTP)
     #+BEGIN_SRC emacs-lisp :tangle no
(setq wl-smtp-posting-server "your smtp server")
(setq wl-smtp-posting-user "your account")
(setq wl-smtp-posting-port 587)
(setq wl-smtp-connection-type 'starttls)
(setq wl-smtp-authenticate-type "login")
     #+END_SRC
**** From に応じて送信サーバをきりかえる.
     本来はメール作成時/返信時の template の切り替えなのだれど,
     送信時の SMTP の設定を from に合わせてきりかえるようにする.
     default に二重に指定しているのは，
     一度別のアカウントに切り替えた後に再びトグルして戻って来た際に元に戻す(上書き)するため.
     #+BEGIN_SRC emacs-lisp :tangle no
(setq wl-template-alist
      '(("default"
         ("From" . wl-from)
         (wl-smtp-posting-server . "your smtp server")
         (wl-smtp-posting-user . "your account")
         (wl-smtp-posting-port . 587)
         (wl-smtp-connection-type . 'starttls)
         (wl-smtp-authenticate-type . "login")
         )
        ("example1"
         ("From" . "Your Name <account@example1.com>")
         (wl-smtp-posting-server . "smtp.example1.com")
         (wl-smtp-posting-user . "your account")
         (wl-smtp-posting-port . 587)
         (wl-smtp-connection-type . 'starttls)
         (wl-smtp-authenticate-type . "login")
         )
        ("example2"
         ("From" . "Your Name <account@example2.com>")
         (wl-smtp-posting-server . "smtp.example2.com")
         (wl-smtp-posting-user . "your account")
         (wl-smtp-posting-port . 587)
         (wl-smtp-connection-type . 'starttls)
         (wl-smtp-authenticate-type . "plain")
         )
        ("ssh:smtp"
         ;; need ssh tunnel
         ;; ssh -f -N -L 20025:localhost:25 smtp.server.com
         ("From" . "Your Name <account@example3.com>")
         (wl-smtp-posting-server . "localhost")
         (wl-smtp-posting-user . "your ssh account")
         (wl-smtp-posting-port . 20025)
         (wl-smtp-connection-type . 'nil)
         (wl-smtp-authenticate-type . 'nil)
         )
        ))
     #+END_SRC
     ssh tunnel を自動的にやる事はできないモンだろうか
     (送信時に open して, 送信後に close する, みたいなの).

     ついでに template の切り替えに関して幾つか設定.
      #+BEGIN_SRC emacs-lisp :tangle init-wl.el
;; template 切り替え時に 内容を表示
(setq wl-template-visible-select t)
      #+END_SRC
      =draft-mode= で =C-c C-n= をするとテンプレートを切り替え
      #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(define-key wl-draft-mode-map "\C-c\C-n" 'wl-template-select)
      #+END_SRC
      from に応じて wl-from, wl-envelope-from,
      送信 smtp サーバを変更する送信時に変更
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(add-hook 'wl-draft-send-hook
          (lambda ()
            (set (make-local-variable 'wl-from)
                 (std11-fetch-field "From"))))
     #+END_SRC
     送信時に自動的に wl-draft-config-alist を適用...しない?
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(remove-hook 'wl-draft-send-hook 'wl-draft-config-exec)
     #+END_SRC
*** 基本設定
**** imap 関連
     デフォルトの認証設定
     フォルダ名は UTF-7 でエンコードされているので,
     表示する際にこれをデコードする
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq elmo-imap4-use-modified-utf7 t)
     #+END_SRC
**** 非同期チェック
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq wl-folder-check-async t)
     #+END_SRC
**** フォルダの位置の default からの変更
     =~/.cache/wanderlust/= に集約している
     local の Mail folder の位置
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq elmo-maildir-folder-path "~/.cache/wanderlust"
      elmo-localdir-folder-path "~/.cache/wanderlust/local")
     #+END_SRC
     local フォルダの設定:
     =.lost+found= は =elmo-maildir-folder-path= からの相対パスになっていることに注意
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq elmo-lost+found-folder ".lost+found")
(setq wl-queue-folder "+queue")
     #+END_SRC
     folders の位置の変更
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq wl-folders-file (concat my:d:password-store "/wl-folders.gpg"))
     #+END_SRC
     Drafts, Trash の置き場所
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq wl-draft-folder "+Drafts")
(setq wl-trash-folder "+Trash")
(setq elmo-lost+found-folder "+lost+found")
(setq wl-temporary-file-directory "~/Downloads/")
     #+END_SRC
     アドレス帳
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq wl-use-petname t)
(setq wl-address-file  "~/.mua/Address")
     #+END_SRC
     LDAP サーバからアドレスを引くことも可能.
     以前は GCALDaemon を使って local に ldap サーバを上げていたのだけれども,
     Google Contacts の API が変わったらしく
     GCALDaemon で LDAP サーバは使えなくなったのでコメントアウト.
     #+BEGIN_SRC emacs-lisp :tangle no
(setq wl-use-ldap t)
(setq wl-ldap-server "localhost")
(setq wl-ldap-port "389")
(setq wl-ldap-base "dc=math,dc=kyoto-u,dc=ac,dc=jp")
     #+END_SRC
     パスワードの保存先
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq elmo-passwd-alist-file-name (concat my:d:password-store "/wl-passwd.gpg"))
     #+END_SRC
**** フォルダ編集時に backup を作成しない.
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq wl-fldmgr-make-backup nil)
     #+END_SRC
**** FCC, BCC の設定
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-fcc nil)
     ;; (setq wl-fcc "%Sent")
     #+END_SRC
     fcc を既読にする場合は以下．=wl-fcc= が nil の場合には意味は無い
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-fcc-force-as-read t)
     #+END_SRC
     bcc は常に自身に.
      #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-bcc (concat user-mail-address))
      #+END_SRC
**** 起動時に =%INBOX= のみをチェック
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-auto-check-folder-name "%INBOX")
     #+END_SRC
**** フォルダ選択時の初期設定
     imap の namespace を毎度入力するのが面倒なので，これを追加しておく.
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-default-spec "%")
     #+END_SRC
**** confirm 関連の設定
     スキャン時の問い合わせの無効化.
     ちなみに confirm を nil にしても 問い合わせが無いだけで
     threshold は効くので, 明示的に nil に.
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq elmo-folder-update-confirm nil)
(setq elmo-folder-update-threshold nil)
(setq elmo-message-fetch-confirm nil)
(setq elmo-message-fetch-threshold nil)
(setq wl-prefetch-confirm nil)
(setq wl-prefetch-threshold nil)
     #+END_SRC
     終了時に確認しない
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-interactive-exit nil)
     #+END_SRC
     送信時は確認する   :tangle init-wl.el
     #+BEGIN_SRC emacs-lisp
(setq wl-interactive-send t)
     #+END_SRC
**** misc.
     大きいメッセージを送信時に分割しない
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq mime-edit-split-message nil)
     #+END_SRC
     スレッドは常に閉じる
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-thread-insert-opened nil)
     #+END_SRC
     3 pain 表示 -> 使わない
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-stay-folder-window nil)
     #+END_SRC
     未読を優先的に読む
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-summary-move-order 'unread)
     #+END_SRC
     改ページ無視
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-break-pages nil)
     #+END_SRC
     icon を使わない → GUI でもメニュー表示してないし, 体感的には遅くなる
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-highlight-folder-with-icon nil)
     #+END_SRC
**** dispose, delete の設定
     Gmail用に%INBOXでは削除を =wl-trash-folder= への移動ではなく，「delete」に．
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(add-to-list 'wl-dispose-folder-alist
             '("^%INBOX" . remove))
     #+END_SRC
     迷惑メール関連も
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(add-to-list 'wl-dispose-folder-alist
             '(".*Junk$" . remove))
     #+END_SRC
**** 折り返しの設定
     message は折り返す.
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-message-truncate-lines nil)
     #+END_SRC
     draft も折り返す
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-draft-truncate-lines nil)
     #+END_SRC
**** mode-line の設定
     長いと嫌なのでイロイロ削る
     #+BEGIN_SRC emacs-lisp   :tangle init-wl.el
(setq wl-summary-mode-line-format "") ; "%f {%t}(%n/%u/%a)"
(setq wl-message-mode-line-format "") ; "<< %f:%F>> [%m]"
     #+END_SRC
*** キーバインド関連
    =use-package= で設定しておいた方が良いかなぁ...
    =C-c C-j= を browse-url に明け渡す
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(define-key wl-draft-mode-map "\C-c\C-j" 'browse-url-at-point)
    #+END_SRC
    =M-u= で unread にする
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(define-key wl-summary-mode-map "\M-u" 'wl-summary-mark-as-unread)
    #+END_SRC
    =i= で sync <- Mew 風
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(define-key wl-summary-mode-map "i" 'wl-summary-sync-update)
    #+END_SRC
    =C-o= は elscreen で使う
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(define-key wl-summary-mode-map "\C-o" nil )
    #+END_SRC
    =M-o= で =auto-refile=  (Mew 風)
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(define-key wl-summary-mode-map "\M-o" 'wl-summary-auto-refile)
    #+END_SRC
*** flag とフォルダを行き来する関数の追加
    "=" でフラグ付きフォルダと
    実際にメッセージのあるフォルダを行き来する.
    Gmail の「スター付き」フォルダでも有効
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(require 'elmo nil 'noerror)
(defun my:wl-summary-jump-to-referer-message ()
  (interactive)
  (when (wl-summary-message-number)
    (if (eq (elmo-folder-type-internal wl-summary-buffer-elmo-folder) 'flag)
        (progn
          (let* ((referer (elmo-flag-folder-referrer
                           wl-summary-buffer-elmo-folder
                           (wl-summary-message-number)))
                 (folder (if (> (length referer) 1)
                             (completing-read
                              (format "Jump to (%s): " (car (car referer)))
                              referer
                              nil t nil nil (car (car referer)))
                           (car (car referer)))))
            (wl-summary-goto-folder-subr folder 'no-sync nil nil t)
            (wl-summary-jump-to-msg (cdr (assoc folder referer)))))
      (when (eq (elmo-folder-type wl-summary-last-visited-folder) 'internal)
        (wl-summary-goto-last-visited-folder)))))
(define-key wl-summary-mode-map "=" 'my:wl-summary-jump-to-referer-message)
    #+END_SRC
*** summary-mode の表示のカスタマイズ
**** 自分が差出人である mail は To:某 と表示
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-summary-showto-folder-regexp ".*")
(setq wl-summary-from-function 'wl-summary-default-from)
     #+END_SRC
**** サマリ行の表示関連
     サマリ行のフォーマット指定
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-summary-line-format
      "%T%P%1@%1>%Y/%M/%D %21(%t%[%19(%c %f%)%]%) %#%~%s"
      wl-summary-width 84)
     #+END_SRC
     サマリ表示は切り詰めない
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-subject-length-limit t)
     #+END_SRC
     スレッドの幅の指定
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-thread-indent-level 2)
(setq wl-thread-have-younger-brother-str "+"
      wl-thread-youngest-child-str "+"
      wl-thread-vertical-str "|"
      wl-thread-horizontal-str "-"
      wl-thread-space-str " ")
     #+END_SRC

     以下の二つの設定を有効にするには
     =elmo-msgdb-extra-fields= を設定する必要がある.
     この変数は振り分け判定にも使用するのでそこで設定している
**** Gmail 風に, 自分宛のメールに ">" をつけて表示する
     元ネタ [[http://d.hatena.ne.jp/khiker/20080206/wanderlust]]
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-user-mail-address-regexp "^uwabami.*\\|^sasakyh.*")
;; 一覧表示での置き換え規則に追加
(defun my:wl-summary-line-for-me ()
  (if (catch 'found
        (let ((to (elmo-message-entity-field wl-message-entity 'to))
              (cc (elmo-message-entity-field wl-message-entity 'cc)))
          (when (or (stringp to) cc)
            (setq to
                  (append (if (stringp to) (list to) to)
                          (when cc
                            (if (stringp cc) (list cc) cc)))))
          (dolist (i to)
            (when (wl-address-user-mail-address-p (eword-decode-string i))
              (throw 'found t)))))
      ">"
    ""))
;; > を summary-line-format に追加
(setq wl-summary-line-format-spec-alist
      (append wl-summary-line-format-spec-alist
              '((?> (my:wl-summary-line-for-me)))))
     #+END_SRC
**** 添付ファイルがあったら, サマリ行に @ を付ける
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-summary-line-format-spec-alist
      (append wl-summary-line-format-spec-alist
              '((?@ (wl-summary-line-attached)))))
     #+END_SRC
**** クォートされた文字列もデコードする
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq mime-header-lexical-analyzer
      '(
        ;; eword-analyze-quoted-string
        eword-analyze-domain-literal
        eword-analyze-comment
        eword-analyze-spaces
        eword-analyze-special
        eword-analyze-encoded-word
        eword-analyze-atom))
     #+END_SRC
**** Subject が変わってもスレッドを切らない
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-summary-divide-thread-when-subject-changed nil)
     #+END_SRC
**** Subject での Tab や複数スペースを無視
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(defadvice std11-unfold-string (after simply activate)
  (setq ad-return-value
        (elmo-replace-in-string ad-return-value "[ \t]+" " ")))
     #+END_SRC
**** 重複メッセージを非表示に
     フォルダ内の Message-ID が同じメールを非表示にする
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-folder-process-duplicates-alist
      '(
        (".*" . hide)
        ))
     #+END_SRC
**** sort 順: 返信が来た順
     =flet= を書き換えるのが面倒で =el-x= にある =dflet= を使うように変更
    #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(defun wl-summary-overview-entity-compare-by-reply-date (a b)
  "Compare message A and B by latest date of replies including thread."
  (dflet ((string-max2 (x y)
                       (cond ((string< x y) y)
                             ('t x)))
          (thread-number-get-date (x)
                                  (timezone-make-date-sortable (elmo-msgdb-overview-entity-get-date
                                                                (elmo-message-entity
                                                                 wl-summary-buffer-elmo-folder x))))
          (thread-get-family (x)
                             (cons x (wl-thread-entity-get-descendant (wl-thread-get-entity x))))
          (max-reply-date (x)
                          (cond ((eq 'nil x)
                                 'nil)
                                ((eq 'nil (cdr x))
                                 (thread-number-get-date (car x)))
                                ('t
                                 (string-max2 (thread-number-get-date (car x))
                                              (max-reply-date (cdr x)))))))
    (string<
     (max-reply-date (thread-get-family (elmo-message-entity-number a)))
     (max-reply-date (thread-get-family (elmo-message-entity-number b))))))
(add-to-list 'wl-summary-sort-specs 'reply-date)
(setq wl-summary-default-sort-spec 'reply-date)
    #+END_SRC
*** 振り分け設定
    =$= 以外を振り分け対象に
    #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-summary-auto-refile-skip-marks '("$"))
    #+END_SRC
**** 振り分け判定に使用するヘッダ
     添付の有無の表示にも使うので =Content-Type= も登録.
     あと =Delivered-To= はメールの検索の時に結構重宝している.
     #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq elmo-msgdb-extra-fields
      '(
        "List-Post"
        "List-Id"
        "List-ID"                  ;; たまに List-ID で来るメールあるよね?
        "Resent-CC"
        "Mailing-List"
        "X-Mailing-List"
        "X-ML-Address"
        "X-ML-Name"
        "X-ML-To"
        "Delivered-To"
        "Content-Type"              ;; 添付の有無の表示の為に追加
        "X-Google-Appengine-App-Id" ;; GAEの送信するメールの振り分け用
        "To"
        "Cc"
        "From"
        "Subject"
        "Reply-To"
        "Auto-Submitted"            ;; Git commit/Cron notify
        ))
     #+END_SRC
*** メッセージ表示
**** いったん全て非表示に
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-message-ignored-field-list '("^.*:"))
     #+END_SRC
**** 見たいヘッダだけ表示
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-message-visible-field-list
      '("^Subject:"
        "^From:"
        "^To:"
        "^Cc:"
        "^Date:"
        "^Message-ID:"
        ))
     #+END_SRC
**** 表示順の変更
     Mew 風...
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-message-sort-field-list
      '("^Subject:"
        "^From:"
        "^To:"
        "^Cc:"
        "^Date:"
        "^Message-ID:"
        ))
     #+END_SRC
**** From, To を省略表示しない
     To や From にアドレスが沢山指定されていると省略されるので，これを無効化
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-message-use-header-narrowing nil)
     #+END_SRC
*** 作成/返信設定
    自分宛のメールに返信する場合は =To:=, =Cc:= から自分のアドレスを削除
    #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-draft-always-delete-myself t)
    #+END_SRC
    "a" (without-argument)では =Reply-To:= や =From:= などで
    指定された唯一人または唯一つの投稿先に返信.
    また, =X-ML-Name:= と =Reply-To:= がついているなら =Reply-To:= 宛に返信
    #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-draft-reply-without-argument-list
      '((("X-ML-Name" "Reply-To") . (("Reply-To") nil nil))
        ("X-ML-Name" . (("To" "Cc") nil nil))
        ("Followup-To" . (nil nil ("Followup-To")))
        ("Newsgroups" . (nil nil ("Newsgroups")))
        ("Reply-To" . (("Reply-To") nil nil))
        ("Mail-Reply-To" . (("Mail-Reply-To") nil nil))
        ("From" . (("From") nil nil))))
    #+END_SRC
    =C-u a= (with-argument)であれば関係する全ての人・投稿先に返信
    #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-draft-reply-with-argument-list
      '(("Followup-To" . (("From") nil ("Followup-To")))
        ("Newsgroups" . (("From") nil ("Newsgroups")))
        ("Mail-Followup-To" . (("Mail-Followup-To") nil ("Newsgroups")))
        ("From" . (("From") ("To" "Cc") ("Newsgroups")))))
    #+END_SRC
    サマリ表示には petname を使うが, 引用には使わない
    #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq wl-default-draft-cite-decorate-author nil)
    #+END_SRC
**** メール本文の文字コード
     丸囲み数字なんかが入ってしまうと
     勝手にエンコーディングが変わってしまって鬱陶しい. どうしたモンだろうかね.
     #+BEGIN_SRC emacs-lisp :tangle no
(add-hook 'wl-draft-mode-hook
          (lambda ()
            (add-to-list 'mime-charset-type-list '(utf-8 8 nil))))
     #+END_SRC
**** draft mode で orgtbl を有効に
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(add-hook 'wl-draft-mode-hook 'turn-on-orgtbl)
     #+END_SRC
**** c-sig
     署名の選択に c-sig を使用している.
     設定は以下の通り. Mew 風に =C-c <tab>= で signature を挿入するようにしている
     #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(leaf c-sig
  :init
  :config
  (setq sig-insert-end t
        sig-save-to-sig-name-alist nil
        message-signature-file nil)
  (define-key wl-draft-mode-map "\C-c\t" 'insert-signature-eref)
  (add-hook 'wl-draft-mode-hook
            '(lambda ()
               (define-key (current-local-map) "\C-c\C-w"
                 'insert-signature-eref)))
  )
     #+END_SRC
*** Face の設定
    デフォルトより細かく指定するために幾つかの face 定義を追加.
   #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq wl-highlight-message-header-alist
      '(("Subject[ \t]*:"
         . wl-highlight-message-subject-header-contents)
        ("From[ \t]*:"
         . wl-highlight-message-from-header-contents)
        ("Date[ \t]*:"
         . wl-highlight-message-date-header-contents)
        ("\\(.*To\\|Cc\\|Newsgroups\\)[ \t]*:"
         . wl-highlight-message-important-header-contents)
        ("\\(User-Agent\\|X-Mailer\\|X-Newsreader\\)[ \t]*:" .
         wl-highlight-message-unimportant-header-contents)
        ))
(defun my:wl-set-face (face spec)
  (make-face face)
  (cond ((fboundp 'face-spec-set)
         (face-spec-set face spec))
        (t
         (wl-declare-face face spec))))
(my:wl-set-face 'wl-highlight-folder-closed-face                  '((t (:foreground "#4cff4c" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-folder-few-face                     '((t (:foreground "#FF4C4C" :bold t :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-folder-killed-face                  '((t (:foreground ,my:h:black :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-folder-many-face                    '((t (:foreground ,my:h:magenta :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-folder-opened-face                  '((t (:foreground "#4cffff" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-folder-path-face                    '((t (:underline t :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-folder-unknown-face                 '((t (:foreground "#4cffff" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-folder-unread-face                  '((t (:foreground ,my:n:blue :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-folder-zero-face                    '((t (:foreground "#F6F3E8" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-header-separator-face               '((t (:inherit highlight :bold t ))))
;; (my:wl-set-face 'wl-highlight-message-citation-header             '((t (:foreground ,my:h:green :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-1                '((t (:foreground "#7fff7f" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-2                '((t (:foreground "#ffff7f" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-3                '((t (:foreground "#7f7fff" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-4                '((t (:foreground "#7fffff" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-5                '((t (:foreground "#ff7fff" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-6                '((t (:foreground "#ff7f7f" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-7                '((t (:foreground "#4cff4c" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-8                '((t (:foreground "#ffff4c" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-9                '((t (:foreground "#4c4cff" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-10               '((t (:foreground "#4cffff" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-11               '((t (:foreground "#ff4cff" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-cited-text-12               '((t (:foreground "#ff4c4c" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-date-header-contents        '((t (:foreground "#4CFF4C" :bold t :italic nil ))))
(my:wl-set-face 'wl-highlight-message-header-contents             '((t (:foreground "#aaaaaa" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-headers                     '((t (:foreground "#4CFFFF" :bold t :italic nil ))))
(my:wl-set-face 'wl-highlight-message-important-header-contents2  '((t (:foreground "#4CFF4C" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-signature                   '((t (:foreground "#aaaaaa" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-message-important-header-contents   '((t (:foreground "#FF4CFF" :bold t :italic nil ))))
(my:wl-set-face 'wl-highlight-message-subject-header-contents     '((t (:foreground "#FF4C4C" :bold t :italic nil ))))
(my:wl-set-face 'wl-highlight-message-from-header-contents        '((t (:foreground "#FFFF4C" :bold t :italic nil ))))
(my:wl-set-face 'wl-highlight-message-unimportant-header-contents '((t (:foreground "#aaaaaa" :bold nil :italic nil ))))
(my:wl-set-face 'wl-highlight-summary-answered-face               '((t (:foreground "#4CFF4C" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-copied-face                 '((t (:foreground "#4CFFFF" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-deleted-face                '((t (:foreground ,my:h:black :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-displaying-face             '((t (:underline t :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-disposed-face               '((t (:foreground "#aaaaaa" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-flagged-face                '((t (:foreground ,my:h:yellow :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-forwarded-face              '((t (:foreground ,my:h:blue :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-high-read-face              '((t (:foreground ,my:h:green :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-high-unread-face            '((t (:foreground ,my:h:orange :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-important-face              '((t (:foreground "#ffff4c" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-important-flag-face         '((t (:foreground "#ffff4c" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-killed-face                 '((t (:foreground ,my:h:black :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-l:read-face                 '((t (:foreground "#4CFF4C" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-l:unread-face               '((t (:foreground ,my:h:lightb :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-new-face                    '((t (:foreground "#ff4c4c" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-normal-face                 '((t (:foreground "#f6f3e8" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-prefetch-face               '((t (:foreground ,my:n:blue :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-summary-refiled-face                '((t (:foreground "#7F7FFF" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-resend-face                 '((t (:foreground ,my:h:orange :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-target-face                 '((t (:foreground "#4CFFFF" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-temp-face                   '((t (:foreground ,my:n:violet :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-summary-thread-top-face             '((t (:foreground "#F6F3E8" :bold t :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-summary-unread-face                 '((t (:foreground "#ff4c4c" :bold nil :italic nil :weight normal ))))
;; (my:wl-set-face 'wl-highlight-thread-indent-face                  '((t (:underline t :bold nil :italic nil :weight normal ))))
   #+END_SRC
*** GPG 署名
    以前は mailcrypt を使っていたけれど,
    epa があるので主にキーバインドの設定のみ.
    =draft-mode= の文字コードをあらかじめ指定しておかないと,
    送信時に文字コードが変換されるので不正な署名となってしまう.

    もっとうまい方法/正攻法がありそうな気がするけれど,
    使えてるから, まあ良いかな, とか.
    #+BEGIN_SRC emacs-lisp :tangle init-wl.el
(setq mime-pgp-verify-when-preview nil)
(defun my:epa-wl-decrypt-message ()
  (interactive)
  (save-window-excursion
    (wl-summary-jump-to-current-message)
    (wl-message-decrypt-pgp-nonmime)))
(defun my:epa-wl-verify-message ()
  (interactive)
  (save-selected-window
    (wl-summary-jump-to-current-message)
    (wl-message-verify-pgp-nonmime)))
(bind-keys :map wl-summary-mode-map
           ("C-c : d" . my:epa-wl-decrypt-message)
           ("C-c : v" . my:epa-wl-verify-message))
(bind-keys :map wl-draft-mode-map
           ("C-c : s" . epa-mail-sign)
           ("C-c : e" . epa-mail-encrypt))
    #+END_SRC
*** 検索
    notmuchを使う.
    #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(leaf elmo-search
  :bind (:map wl-summary-mode-map
              ("v" . wl-quicksearch-goto-search-folder-wrapper)
              :map wl-folder-mode-map
              ("v" . wl-quicksearch-goto-search-folder-wrapper))
  :config
   ;; (elmo-search-register-engine
   ;;  'mu-custom 'local-file
   ;;  :prog "mu"
   ;;  :args '("find" "-u" elmo-search-split-pattern-list
   ;;          "--fields" "l" "--sortfield" "date" "-r")
   ;;  :charset 'utf-8
   ;;  )
  (elmo-search-register-engine
   'notmuch-custom 'local-file
   :prog "notmuch-query-custom"
   :args '(elmo-search-split-pattern-list)
   :charset 'utf-8)
  (setq elmo-search-default-engine 'notmuch-custom)
  (setq wl-quicksearch-folder "[]")
  )
    #+END_SRC
    実際の呼び出しはスレッドを全部取得したいので以下を呼び出している
    #+BEGIN_SRC sh :tangle no
#!/bin/sh
if [ ! x"$*" = x"" ] ; then
    res=$(notmuch search --output=threads "$*")
fi
if [ ! x"$res" = x"" ] ; then
    echo $res | xargs notmuch search --sort=oldest-first --output=files
fi
    #+END_SRC
    検索時にメールが多すぎると怒られるので. 数字は適当.
    #+BEGIN_SRC emacs-lisp  :tangle init-wl.el
(setq elmo-multi-divide-number 2000000000)
(setq elmo-multi-number 2000000000)
    #+END_SRC
** Linux Desktop で =mailto:= リンクを扱うために
  ついでに =mailto= のリンクを emacsclient で扱うために，以下の関数を定義しておく
  #+BEGIN_SRC emacs-lisp
(defun my:mailto-compose-mail (mailto-url)
  (if (and (stringp mailto-url)
           (string-match "\\`mailto:" mailto-url))
      (progn
        (require 'rfc2368)
        (let* ((headers (mapcar (lambda (h) (cons (intern (car h)) (cdr h)))
                                (rfc2368-parse-mailto-url mailto-url)))
               (good-headers (remove-if (lambda (h) (member (car h) '(Body))) headers))
               (body (cdr (assoc 'Body headers))))
          (wl-draft good-headers nil nil body)))))
  #+END_SRC
  Desktop の設定では
  #+BEGIN_SRC sh :tangle no
#!/bin/sh
# emacs-mailto-handler

mailto=$1
mailto="mailto:${mailto#mailto:}"
mailto=$(printf '%s\n' "$mailto" | sed -e 's/[\"]/\\&/g')
elisp_expr="(my:mailto-compose-mail \"$mailto\")"

emacsclient -a "" -n --eval "$elisp_expr" \
	'(set-window-dedicated-p (selected-window) t)'
  #+END_SRC
  をメーラとして指定すれば良い．
  GNOME は =.desktop= ファイルが無いと「お気に入り」登録ができないので
  以下のファイルを適当な名前で =~/.local/share/applications/= 以下に放り込んでおくと良いだろう
  #+BEGIN_SRC conf :tangle no
[Desktop Entry]
Name=Emacs Mail Handler
GenericName=Mail User Agent
X-GNOME-FullName=Emacs Mail Handler
Comment=Use emacsclient as MUA, handling mailto link
Keywords=email
Exec=/home/uwabami/bin/emacs-mailto-handler %U
Icon=emacs25
Terminal=false
Type=Application
Categories=GNOME;GTK;Office;Email;
StartupNotify=false
MimeType=application/mbox;message/rfc822;x-scheme-handler/mailto;
  #+END_SRC
** メールからの予定の取り込み: =mhc=
   #+BEGIN_SRC emacs-lisp
(leaf mhc
  :if (file-directory-p (concat (getenv "HOME") "/.config/mhc"))
  :ensure t
  :config
  (setq mhc-calendar-day-strings ["日" "月" "火" "水" "木" "金" "土"]
        mhc-calendar-header-function 'mhc-calendar-make-header-ja
        mhc-calendar-language 'japanese)
  )
   #+END_SRC
* 起動時間の計測
  [[http://memo.sugyan.com/entry/20120120/1327037494][起動時間を計測する 改訂版 - すぎゃーんメモ]]
  #+BEGIN_SRC emacs-lisp
(defun my:emacs-init-time ()
  "Emacs booting time in msec."
  (message "Emacs booting time: %.0f [msec] = `emacs-init-time'."
           (* 1000
              (float-time (time-subtract
                           after-init-time
                           before-init-time)))))
(add-hook 'after-init-hook #'my:emacs-init-time)
  #+END_SRC
* 警告の抑制
  普段は殆んど見ない.
  #+BEGIN_SRC emacs-lisp
;; (setq byte-compile-warnings
;;       '(free-vars
;;         unresolved
;;         callargs
;;         redefine
;; ;;        obsolete
;;         noruntime
;;         cl-functions
;;         interactive-only
;;         make-local))
;; (setq ad-redefinition-action 'accept)
  #+END_SRC
* エラー表示の抑制
  これも普段は見ない.
  #+BEGIN_SRC emacs-lisp
;; (setq debug-on-error nil)
  #+END_SRC
* フォントと色
  そろそろテーマにした方が良い，とは思ってはいる．
  #+BEGIN_SRC emacs-lisp
(setq ansi-color-names-vector
      [unspecified "#242424" "#FF4c4c" "#4cff4c" "#ffff4c"
                   "#4c4cff" "#ff4cff" "#4cffff" "#f6f3e8"]
      )
(defun my:load-window-config ()
  "load window-system specific settings"
  (interactive)
  (when window-system
    (progn
      (set-frame-parameter nil 'alpha 90)
      (set-face-attribute 'default nil
                          :family "RictyDiscord"
                          :height 180)
      (set-face-attribute 'fixed-pitch nil
                          :family "RictyDiscord"
                          :height 180)
      (set-face-attribute 'variable-pitch nil
                          :family "RictyDiscord"
                          :height 180)
      (set-background-color "#242424")
      )))
(setq frame-background-mode (frame-parameter nil 'background-mode))
(setq default-frame-alist
      '(
        (foreground-color . "#F6F3E8")
        (scroll-bar-foreground-color . "red")
        (vertical-scroll-bars . right)
        ))
(when (window-system)
  (my:load-window-config))
  #+END_SRC
  現在修正中．
  #+BEGIN_SRC emacs-lisp
(custom-set-faces
 '(default                             ((t (:foreground "#F6F3E8" ))))
 '(cursor                              ((t (:foreground "#4CFF4C" :background "#4CFF4C" ))))
 ;; basic
 '(font-lock-builtin-face              ((t (:foreground "#7FBFFF" ))))
 '(font-lock-comment-delimiter-face    ((t (:foreground "#a5a5a6" ))))
 '(font-lock-comment-face              ((t (:foreground "#a5a5a6" ))))
 '(font-lock-constant-face             ((t (:foreground "#FFBF7F" ))))
 '(font-lock-doc-face                  ((t (:foreground "#7FFF7F" ))))
 '(font-lock-doc-string-face           ((t (:foreground "#7FFF7F" ))))
 '(font-lock-function-name-face        ((t (:foreground "#BF7FFF"))))
 '(font-lock-keyword-face              ((t (:foreground "#FF7F7F"))))
 '(font-lock-link-face                 ((t (:foreground "#7FFFFF" ))))
 '(font-lock-negation-char-face        ((t (:foreground "#7FFFFF" :bold t   :italic nil))))
 '(font-lock-preprocessor-face         ((t (:foreground "#FF4C4C" :bold nil :italic nil))))
 '(font-lock-regexp-grouping-backslash ((t (:foreground "#A5EE4C" :bold t   :italic nil))))
 '(font-lock-regexp-grouping-construct ((t (:foreground "#7F7FFF" :bold t   :italic nil))))
 '(font-lock-string-face               ((t (:foreground "#7FFF7F" ))))
 '(font-lock-type-face                 ((t (:foreground "#FFFF7F" ))))
 '(font-lock-variable-name-face        ((t (:foreground "#7F7FFF" ))))
 '(font-lock-warning-face              ((t (:foreground "#FF7FBF" :bold t ))))
 '(mode-line                           ((t (:foreground "#F6F3E8" :background "#222244" ))))
 '(mode-line-inactive                  ((t (:foreground "#666666" :background "#999999" :bold nil ))))
 '(fringe                              ((t (:foreground "#666666" :background "#282828" ))))
;; '(hl-line                           ((t (:inherit highlight :underline t ))))
;; '(highlight                         ((t (:background "#333333" ))))
 '(term-color-black                    ((t (:background "#242424" :foreground "#242424"))))
 '(term-color-blue                     ((t (:background "#4c4cff" :foreground "#4c4cff"))))
 '(term-color-cyan                     ((t (:background "#4cffff" :foreground "#4cffff"))))
 '(term-color-green                    ((t (:background "#4cff4c" :foreground "#4cff4c"))))
 '(term-color-magenta                  ((t (:background "#ff4cff" :foreground "#ff4cff"))))
 '(term-color-red                      ((t (:background "#ff4c4c" :foreground "#ff4c4c"))))
 '(term-color-white                    ((t (:background "#f6f3e8" :foreground "#f6f3e8"))))
 '(term-color-yellow                   ((t (:background "#ffff4c" :foreground "#ffff4c"))))
  ;;
 '(minibuffer-prompt                   ((t (:foreground "#BF7FFF" ))))
 '(region                              ((t (:background "#222244" ))))
 ;; dired
 '(dired-directory                     ((t (:bold t :foreground "#7F7FFF" ))))
 '(dired-flagged                       ((t (:inherit error ))))
 ;; '(dired-header
 '(dired-ignored                       ((t (:inherit shadow ))))
 ;; '(dired-mark
 ;; '(dired-marked
 '(dired-perm-write                    ((t (:bold t :foreground "#FFFF7F" ))))
 '(dired-symlink                       ((t (:bold t :foreground "#7FFFFF" ))))
 '(dired-warning                       ((t (:inherit font-lock-warning-face ))))
 ;; helm
 '(helm-source-header                  ((t (:foreground "#F6F3E8" :background "#224488" :bold t))))
 '(helm-visible-mark                   ((t (:inherit highlight ))))
 '(helm-selection                      ((t (:inherit highlight ))))
 '(helm-selection-line                 ((t (:inherit highlight ))))
 '(helm-ff-directory                   ((t (:inherit dired-directory ))))
 '(helm-bookmark-directory             ((t (:inherit helm-ff-directory ))))
 '(helm-buffer-directory               ((t (:inherit helm-ff-directory ))))
 '(helm-ff-dotted-directory            ((t (:inherit helm-ff-directory ))))
 '(helm-ff-file                        ((t (:inherit default ))))
 '(helm-bookmark-file                  ((t (:inherit helm-ff-file ))))
 '(helm-buffer-file                    ((t (:inherit helm-ff-file ))))
 '(helm-grep-file                      ((t (:inherit helm-ff-file ))))
 '(helm-etags-file                     ((t (:inherit helm-ff-file ))))
 '(helm-ff-executable                  ((t (:inherit helm-ff-file :foreground "#7FFF7F" :bold t))))
 '(helm-ff-symlink                     ((t (:inherit default :foreground "#7FFFFF" :bold t))))
 '(helm-ff-dotted-symlink-directory    ((t (:inherit helm-ff-symlink ))))
 '(helm-ff-invalid-symlink             ((t (:inherit default :foreground "#FF7F7F" ))))
 ;; ido
 '(ido-first-match                     ((t (:underline t :weight bold))))
 '(ido-only-match                      ((t (:foreground "#FFFF4C" :overline nil :weight bold))))
 '(ido-subdir                          ((t (:inherit dired-directory))))
 ;; '(ido-vertical-first-match-face       ((t (:inherit ido-first-match))))
 ;;'(ido-vertical-match-face             ((t (:foreground "#4CFF4C"))))
 ;; '(ido-grid-mode-match ((t (:inherit ido-first-match ))))
 ;; powerline
 '(powerline-active1                   ((t (:background "#000000":foreground "#F6F3E8"))))
 '(powerline-active2                   ((t (:background "#666666" :foreground "#F6F3E8"))))
 '(powerline-inactive1                 ((t (:inherit modeline-inactive))))
 '(powerline-inactive2                 ((t (:inherit modeline-inactive))))
 ;; preview-latex
 '(font-latex-sectioning-0-face        ((t (:inherit font-latex-sectioning-1-face))))
 '(font-latex-sectioning-1-face        ((t (:inherit font-latex-sectioning-2-face))))
 '(font-latex-sectioning-2-face        ((t (:inherit font-latex-sectioning-3-face))))
 '(font-latex-sectioning-3-face        ((t (:inherit font-latex-sectioning-4-face))))
 '(font-latex-sectioning-4-face        ((t (:inherit font-latex-sectioning-5-face ))))
 '(font-latex-sectioning-5-face        ((t (:inherit font-lock-type-face :bold t))))
 '(font-latex-slide-title-face         ((t (:inherit font-lock-type-face :bold t))))
 '(font-latex-subscript-face           ((t nil)))
 '(font-latex-superscript-face         ((t nil)))
 '(font-latex-math-face                ((t (:inherit font-lock-constant-face ))))
 '(font-latex-script-char-face         ((t (:inherit font-lock-preprocessor-face :bold t))))
 '(font-latex-verbatim-face            ((t (:inherit font-lock-doc-string-face ))))
 ;; elscreen
 '(elscreen-tab-control-face           ((t (:background "#222244" :foreground "#f6f3e8" :underline t :bold t ))))
 '(elscreen-tab-current-screen-face    ((t (:background "#222244" :foreground "#f6f3e8" :underline t :bold t ))))
 '(elscreen-tab-other-screen-face      ((t (:background "#222244" :foreground "#aaaaaa" :underline t :bold nil ))))
 '(elscreen-tab-background-face        ((t (:background "#222244" :foreground "#aaaaaa" :underline t :bold nil ))))
 ;; git-gutter
 '(git-gutter:added                    ((t (:inherit default :bold t :foreground "#4CFF4C" :background "#666666"))))
 '(git-gutter:deleted                  ((t (:inherit default :bold t :foreground "#FF7FBF" :background "#666666"))))
 '(git-gutter:modified                 ((t (:inherit default :bold t :foreground "#FFFF4C" :background "#666666"))))
 '(git-gutter:unchanged                ((t (:inherit default :background "#666666" ))))
 '(git-gutter:separator-face           ((t (:inherit default :foreground "#FF4C4C" :background "#666666"))))
  ;;; howm
 '(howm-mode-keyword-face              ((t (:foreground "#7F7FFF" :background nil ))))
 '(howm-mode-title-face                ((t (:foreground "#4CFFFF" :background nil ))))
 '(howm-reminder-deadline-face         ((t (:bold t :foreground "#FF4C4C" :background nil ))))
 '(howm-reminder-late-deadline-face    ((t (:bold t :underline t :foreground "#FF0000" :background nil ))))
 '(howm-reminder-today-face            ((t (:bold t :foreground "#FFBF7F" :background nil ))))
 '(howm-reminder-tomorrow-face         ((t (:bold t :foreground "#FF7FBF" :background nil ))))
 ;; outline
 '(outline-1                           ((t (:inherit font-lock-function-name-face :bold t))))
 '(outline-2                           ((t (:inherit font-lock-string-face :bold t))))
 '(outline-3                           ((t (:inherit font-lock-keyword-face :bold t))))
 '(outline-4                           ((t (:inherit font-lock-type-face :bold t ))))
 '(outline-5                           ((t (:inherit font-lock-constant-face :bold t ))))
 '(outline-6                           ((t (:inherit font-lock-variable-name-face :bold t))))
 '(outline-7                           ((t (:inherit font-lock-builtin-face :bold t ))))
 '(outline-8                           ((t (:inherit font-lock-comment-face :bold t ))))
 ;; org
 '(org-agenda-date-today               ((t (:underline t ))))
 '(org-agenda-date                     ((t (:foreground "#FFFFFF" ))))
 '(org-agenda-date-weekend             ((t (:foreground "#FF7F7F" :bold t))))
 '(org-agenda-calendar-event           ((t (:foreground "#F6F3E8" ))))
 '(org-hide                            ((t (:foreground "#4C4C4C" ))))
 ;;
 ;; moinmoin
 '(moinmoin-h1                         ((t (:inherit outline-1))))
 '(moinmoin-h2                         ((t (:inherit outline-2))))
 '(moinmoin-h3                         ((t (:inherit outline-3))))
 '(moinmoin-h4                         ((t (:inherit outline-4))))
 '(moinmoin-h5                         ((t (:inherit outline-5))))
 '(moinmoin-url                        ((t (:inherit font-lock-link-face))))
 '(moinmoin-url-title                  ((t (:inherit moinmoin-url :bold t))))
 '(moinmoin-anchor-ref-id              ((t (:inherit moinmoin-url :underline t))))
 '(moinmoin-anchor-ref-title           ((t (:inherit moinmoin-url :bold t))))
 '(moinmoin-wiki-link                  ((t (:inherit moinmoin-url :underline t ))))
 '(moinmoin-inter-wiki-link            ((t (:inherit moinmoin-url :underline t ))))
 '(moinmoin-item                       ((t (:inherit font-lock-doc-face ))))
 '(moinmoin-item-2                     ((t (:inherit font-lock-doc-face ))))
 )
;; review
;; '(review-mode-header1-face  ((t (:inherit outline-1))))
;; '(review-mode-header2-face  ((t (:inherit outline-2))))
;; '(review-mode-header3-face  ((t (:inherit outline-3))))
;; '(review-mode-header4-face  ((t (:inherit outline-4))))
;; '(review-mode-header5-face  ((t (:inherit outline-5))))
  #+END_SRC
* =powerline=: モードラインを綺麗に
** ddskk の表示のカスタマイズ
   SKK の状態がヒョコヒョコ動くのが嫌なので，
   =skk-modeline-input-mode= に常に現在の状況を表示する様にしておく．
 #+BEGIN_SRC emacs-lisp
(defun my:skk-modeline-input-mode ()
  "skk が読み込まれていない場合でも skk-modeline-input-mode に文字を入れて返す"
  (unless (boundp 'skk-modeline-inpt-mode)
    (setq skk-modeline-input-mode "--[--]:")))
(my:skk-modeline-input-mode)
   #+END_SRC
 ddskk そのものに modeline を更新する関数があるので無効化する
   #+BEGIN_SRC emacs-lisp
(defadvice skk-setup-modeline (around my:disable-skk-setup-modeline activate)
  "skk-setup-modeline による modeline の更新を無効化"
  (setq skk-indicator-alist (skk-make-indicator-alist))
  (force-mode-line-update t))
   #+END_SRC
** powerline 本体の設定．
   default-theme をベースに見たい物だけ表示するようにしてみた．
   変更点として,
   - separater は環境によってズレるので，半角スペースに変更
   - vc-mode でのアイコン表示に U+26A1⚡ High Voltage を使う
   といった事をしている. East Asian ambiguous Width char の扱いは面倒ですね
   #+BEGIN_SRC emacs-lisp
(leaf powerline
  :ensure t
  :config
  (setq powerline-default-separator 'utf-8
        ;; 半角スペース
        powerline-utf-8-separator-left  #x20
        powerline-utf-8-separator-right  #x20
        ;; デフォルトの⇔
        ;; powerline-utf-8-separator-left  #xe0b0
        ;; powerline-utf-8-separator-right #xe0b2
        ;; 上三角, 下三角
        ;; powerline-utf-8-separator-left  #xe0bc
        ;; powerline-utf-8-separator-right #xe0be
        ;; 壊れ枠
        ;; powerline-utf-8-separator-left  #xe0d2
        ;; powerline-utf-8-separator-right #xe0d4
        )
  (defpowerline my:powerline-vc
    (when (and (buffer-file-name (current-buffer)) vc-mode)
      (format "%s%s"
              (char-to-string #x26a1)
              (format-mode-line '(vc-mode vc-mode)))))
  (defun my:powerline-theme ()
    "Setup customize theme."
    (interactive)
    (setq-default
     mode-line-format
     '("%e"
       (:eval
        (let* ((active (powerline-selected-window-active))
               (mode-line-buffer-id (if active 'mode-line-buffer-id 'mode-line-buffer-id-inactive))
               (mode-line (if active 'mode-line 'mode-line-inactive))
               (face1 (if active 'powerline-active1 'powerline-inactive1))
               (face2 (if active 'powerline-active2 'powerline-inactive2))
               (separator-left (intern (format "powerline-%s-%s"
                                               (powerline-current-separator)
                                               (car powerline-default-separator-dir))))
               (separator-right (intern (format "powerline-%s-%s"
                                                (powerline-current-separator)
                                                (cdr powerline-default-separator-dir))))
               (lhs (list
                     (powerline-raw (substring skk-modeline-input-mode 2 -1) nil 'l)
                     (powerline-raw mode-line-mule-info mode-line 'l)
                     (powerline-raw "%*" mode-line 'l)
                     (powerline-buffer-id mode-line-buffer-id 'l)
                     (powerline-raw " ")
                     (funcall separator-left mode-line face1)
                     (powerline-major-mode face1 'l)
                     (powerline-process face1)
                     (powerline-narrow face1 'l)
                     (powerline-raw " " face1)
                     (funcall separator-left face1 face2)
                     (my:powerline-vc face2 'r)
                     ))
               (rhs (list
                     (powerline-raw global-mode-string face2 'r)
                     (funcall separator-right face2 face1)
                     (powerline-raw " " face1)
                     (powerline-minor-modes face1 'r)
                     (funcall separator-right face1 mode-line)
                     (powerline-raw "  ")
                     (powerline-raw "%6p" mode-line 'r)
                     ))
               )
          (concat (powerline-render lhs)
                  (powerline-fill face2 (powerline-width rhs))
                  (powerline-render rhs)))))))
  (my:powerline-theme)
  )
  #+END_SRC
